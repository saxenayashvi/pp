# ============================================================
# PAGE 2: CHOOSE TOOL
# ============================================================
elif current_page == "choose_tool":
    if USE_INTERNAL_BG_AND_LOGO:
        inject_background()
        inject_logo()

    st.markdown(
        """
        <style>
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            height: 100vh !important;
            overflow: hidden !important;
        }

        .block-container {
            padding-top: 1.5rem !important;
            margin-top: 60px !important;
        }

        header, footer { visibility: hidden !important; height: 0 !important; }
        [data-testid="stToolbar"] { display: none !important; }
        [data-testid="stHeader"] { display: none !important; }

        div[data-testid="stImage"] {
            display: flex !important;
            justify-content: center !important;
            margin-bottom: 10px !important;
        }

        div[data-testid="stButton"] {
            display: flex !important;
            justify-content: center !important;
        }

        div[data-testid="stButton"] > button {
            min-width: 140px !important;
            border-radius: 10px !important;
            background: #ffd54f !important;
            color: #1a1a1a !important;
            font-weight: 700 !important;
            border: none !important;
        }

        .fixed-back-btn {
            position: fixed;
            top: 28px;
            left: 40px;
            z-index: 9999;
        }

        .fixed-back-btn a {
            display: inline-block;
            background: white;
            color: #1a1a1a !important;
            font-weight: 700 !important;
            font-size: 1.4rem !important;
            padding: 0.4rem 1.2rem !important;
            border-radius: 10px !important;
            text-decoration: none !important;
            min-width: 140px !important;
            text-align: center !important;
        }

        </style>

        <div class="fixed-back-btn">
            <a href="?page=home" target="_self">BI4BI</a>
        </div>
        """,
        unsafe_allow_html=True
    )

    st.markdown(
        "<h2 style='text-align:center; margin-bottom:40px;'>Select a BI Environment</h2>",
        unsafe_allow_html=True
    )

    tools = [
        {"name": "Tableau", "logo": "tableau.png", "adapter_key": "tableau"},
        {"name": "Cognos", "logo": "cognos.png", "adapter_key": None},
        {"name": "Power BI", "logo": "powerbi.png", "adapter_key": None},
        {"name": "SQL Server", "logo": "SSRS.png", "adapter_key": None},
        {"name": "Oracle OBIEE", "logo": "oracleOBIEE.png", "adapter_key": None},
        {"name": "SAP BusinessObjects", "logo": "sap-bo.png", "adapter_key": None},
        {"name": "MicroStrategy", "logo": "strategy.png", "adapter_key": None},
    ]

    assets_dir = BASE / "assets"

    # ---------- FIRST ROW (4 tools) ----------
    row1 = st.columns(4)

    for i in range(4):
        tool = tools[i]
        with row1[i]:
            logo_path = assets_dir / tool["logo"]
            if logo_path.exists():
                st.image(str(logo_path), width=120)

            key_safe = tool["name"].replace(" ", "_")

            if tool["adapter_key"]:
                if st.button("Configure", key=f"btn_{key_safe}"):
                    st.session_state["selected_tool"] = tool["name"]
                    st.session_state["page"] = "configure"
                    st.rerun()
            else:
                if st.button("Configure", key=f"btn_{key_safe}_coming"):
                    st.session_state["coming_soon_tool"] = tool["name"]
                    st.rerun()

    st.markdown("<br><br>", unsafe_allow_html=True)

    # ---------- SECOND ROW (3 tools centered) ----------
    row2 = st.columns([1, 1, 1, 1, 1])

    for idx, tool in enumerate(tools[4:]):
        with row2[idx + 1]:
            logo_path = assets_dir / tool["logo"]
            if logo_path.exists():
                st.image(str(logo_path), width=120)

            key_safe = tool["name"].replace(" ", "_")

            if tool["adapter_key"]:
                if st.button("Configure", key=f"btn_{key_safe}2"):
                    st.session_state["selected_tool"] = tool["name"]
                    st.session_state["page"] = "configure"
                    st.rerun()
            else:
                if st.button("Configure", key=f"btn_{key_safe}_coming2"):
                    st.session_state["coming_soon_tool"] = tool["name"]
                    st.rerun()




def render_configure_page(selected_tool: str = 'Tableau'):

    cred_path, server_saved, api_version_saved, token_name_saved, token_secret_saved, site_name_saved = _load_saved_credentials()

    # ------------------- PAGE STYLING -------------------
    st.markdown("""
    <style>
        html, body, .stApp {
            height: 100vh !important;
            overflow: hidden !important;
        }

        header, footer { visibility: hidden !important; height: 0 !important; }
        [data-testid="stToolbar"] { display: none !important; }

        .center-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 40px;
        }

        .form-card {
            background: rgba(255,255,255,0.95);
            padding: 35px 45px;
            border-radius: 14px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.08);
            width: 520px;
        }

        div[data-testid="stForm"] button {
            background-color: #FFD100 !important;
            color: #000 !important;
            font-weight: 700 !important;
            border-radius: 8px !important;
            border: none !important;
        }

        div[data-testid="stForm"] button:hover {
            background-color: #FFC000 !important;
        }

        .upload-section {
            width: 520px;
            margin-top: 30px;
        }

        .bottom-buttons {
            width: 520px;
            margin-top: 25px;
        }

        .bottom-buttons button {
            border-radius: 8px !important;
            font-weight: 700 !important;
        }

    </style>
    """, unsafe_allow_html=True)

    # ------------------- HEADER -------------------
    st.markdown(
        f"<h2 style='text-align:center;'>Configure {selected_tool}</h2>",
        unsafe_allow_html=True
    )
    st.markdown(
        "<p style='text-align:center; color:#555;'>Provide Tableau connection details (personal access token).</p>",
        unsafe_allow_html=True
    )

    st.markdown("<div class='center-wrapper'>", unsafe_allow_html=True)
    st.markdown("<div class='form-card'>", unsafe_allow_html=True)

    # ------------------- FORM -------------------
    with st.form('tableau'):

        server = st.text_input('Server', value=server_saved)
        api_version = st.text_input('API version', value=api_version_saved)
        token_name = st.text_input('Token name', value=token_name_saved)
        token_secret = st.text_input('Token secret', value=token_secret_saved)
        site_name = st.text_input('Site name', value=site_name_saved)

        test_conn = st.form_submit_button('Test Connection', use_container_width=True)

    st.markdown("</div>", unsafe_allow_html=True)

    # ------------------- TEST CONNECTION -------------------
    if test_conn:
        if server and token_name and token_secret:
            with st.spinner('Testing connection...'):
                try:
                    config = {
                        'tableau_prod': {
                            'server': server,
                            'api_version': api_version,
                            'personal_access_token_name': token_name,
                            'personal_access_token_secret': token_secret,
                            'site_name': site_name,
                        }
                    }
                    adapter_key = selected_tool.lower() if selected_tool else 'tableau'
                    r = requests.post(
                        f'{BACKEND_URL}/reports/test-connection',
                        json={'adapter': adapter_key, 'config': config},
                        timeout=30,
                    )
                    r.raise_for_status()
                    st.success('Connection successful!')
                except Exception as e:
                    st.error(f'Connection failed: {e}')
        else:
            st.warning('Please fill required fields.')

    # ------------------- UPLOAD SECTION -------------------
    st.markdown("<div class='upload-section'>", unsafe_allow_html=True)

    uploaded_file = st.file_uploader("Upload metadata file", type=["csv"])
    if uploaded_file is not None:
        try:
            df_upload = pd.read_csv(uploaded_file)
            st.success(f"Uploaded {uploaded_file.name}")
            st.dataframe(df_upload.head())
        except Exception as e:
            st.error(f"Failed to read CSV: {e}")

    st.markdown("</div>", unsafe_allow_html=True)

    # ------------------- SAVE & CANCEL -------------------
    st.markdown("<div class='bottom-buttons'>", unsafe_allow_html=True)
    col1, col2 = st.columns(2)

    with col1:
        save = st.button("Save", use_container_width=True)

    with col2:
        cancel = st.button("Cancel", use_container_width=True)

    st.markdown("</div>", unsafe_allow_html=True)

    # ------------------- SAVE LOGIC -------------------
    if save:
        try:
            dfw = pd.DataFrame({
                'server_saved': [server],
                'api_version_saved': [api_version],
                'token_name_saved': [token_name],
                'token_secret_saved': [token_secret],
                'site_name_saved': [site_name],
                'site_url_saved': ['']
            })
            os.makedirs(os.path.dirname(cred_path), exist_ok=True)
            dfw.to_csv(cred_path, index=False)
            st.success('Credentials saved')
        except Exception as e:
            st.error(f'Failed saving credentials: {e}')

    # ------------------- CANCEL LOGIC (BACK BEHAVIOR) -------------------
    if cancel:
        # Clear selected tool to avoid leftover state
        if "selected_tool" in st.session_state:
            del st.session_state["selected_tool"]

        st.session_state["page"] = "choose_tool"
        st.rerun()
